@using Application.Schema.BudgetTracking.Models
@using Components.Shared
@using Microsoft.Extensions.Logging
@inherits StatefulComponent
@inject AppBudgetTracking.GetBudget.IHandler GetBudgetHandler
@inject AppBudgetTracking.GetAccount.IHandler GetAccountHandler
@inject AppBudgetTracking.CreateTransaction.IHandler CreateTransactionHandler
@inject AppBudgetTracking.UpdateTransaction.IHandler UpdateTransactionHandler
@inject AppBudgetTracking.DeleteTransaction.IHandler DeleteTransactionHandler
@inject ILogger<TransactionGrid> Logger

<RadzenDataGrid @ref="@grid"
				Responsive="true"
				AllowColumnResize="true"
				AllowAlternatingRows="true"
				EditMode="DataGridEditMode.Single"
				Density="Density.Compact"
				RowCreate="@OnCreateAsync"
				RowUpdate="@OnUpdateAsync"
				TItem="TransactionInfo"
				LoadData="@LoadData"
				Data="@Data">
	<Columns>
		<RadzenDataGridColumn Width="30px"
							  Property="Date"
							  Title="Date"
							  TextAlign="TextAlign.Left">
			<Template Context="data">
				@data.Date.ToString("d")
			</Template>
			<EditTemplate Context="data">
				<RadzenDatePicker @bind-Value="@data.Date" ShowCalendarWeek="true" DateFormat="dd-MM-yyyy" ShowButton="false"  />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="35px"
							  Property="BudgetType"
							  Title="Budget Type"
							  TextAlign="TextAlign.Left">
			<EditTemplate Context="data">
				<RadzenDropDown @bind-Value="@data.BudgetType" Data="@budgetItemTypes" Change="async (args) => await OnBudgetItemTypeChangedAsync(args)" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="30px"
							  Property="Budget.BudgetItemDesc"
							  Title="Budget Category"
							  TextAlign="TextAlign.Left">
			<EditTemplate Context="data">
				<RadzenDropDown @bind-Value="@selectedBudgetId"
								Data="@budgets"
								TextProperty="BudgetItemDesc"
								ValueProperty="Id" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="30px"
							  Property="Amount"
							  Title="Amount"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@data.Amount.ToCurrency()
			</Template>
			<EditTemplate Context="data">
				<RadzenNumeric Name="Amount" @bind-Value="@data.Amount" Min="0" ShowUpDown="false" Style="width:100%" />
				<RadzenNumericRangeValidator Component="Amount" Min="0.00m" Text="Amount can't be less than zero" Popup="true" Style="display: block" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="35px"
							  Property="Account"
							  Title="Account"
							  TextAlign="TextAlign.Left">
			<EditTemplate Context="data">
				<RadzenAutoComplete Name="Account"
									Data="@accounts"
									@bind-Value="@selectedAccount"
									FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
									FilterOperator="StringFilterOperator.Contains"
									Style="width: 100%" />
				<RadzenRequiredValidator Component="Account" Text="@($"Account is required")" Popup="false" Style="display: block" />
				<RadzenRegexValidator Component="Account" Text="@($"Account shouldn't conatin any special characters")" Pattern="[a-zA-Z\d ]*" Popup="false" Style="display: block" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Property="Description"
							  Title="Description"
							  TextAlign="TextAlign.Left">
			<EditTemplate Context="data">
				<RadzenTextArea @bind-Value="@data.Description" Cols="25" Rows="1" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="30px"
							  Property="EffectiveDate"
							  Title="Effective Date"
							  TextAlign="TextAlign.Center">
			<Template Context="data">
				@if(data.Date == data.EffectiveDate)
				{
					@(" - ")
				}
				else
				{
					@data.EffectiveDate.ToString("d")
				}
			</Template>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<HeaderTemplate>
				<RadzenButton Icon="add_circle" Text="Add" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" Click="@OnAddRowAsync" />
			</HeaderTemplate>
			<Template Context="data">
				<RadzenIcon Icon="edit" @onclick="async (args) => await OnEditRowAsync(data)" Style="cursor:pointer" />
				<RadzenIcon Icon="delete" IconStyle="IconStyle.Danger" @onclick="async () => await OnDeleteAsync(data)" Style="cursor:pointer" />
			</Template>
			<EditTemplate Context="data">
				<RadzenIcon Icon="check_circle" IconStyle="IconStyle.Success" @onclick="async (args) => await OnSaveRowAsync(data)" Style="cursor:pointer" />
				<RadzenIcon Icon="cancel" IconStyle="IconStyle.Danger" @onclick="async (args) => await OnCancelEditAsync(data)" Style="cursor:pointer" />
			</EditTemplate>
		</RadzenDataGridColumn>
	</Columns>
</RadzenDataGrid>
