@using Application.Features.BudgetPlanning.CreateBudget
@using Application.Features.BudgetPlanning.DeleteBudget
@using Application.Features.BudgetPlanning.GetCategory
@using Application.Features.BudgetPlanning.UpdateBudget
@using Application.Shared.Models
@using Components.Shared
@using Components.Shared.Models
@using Microsoft.Extensions.Logging
@inherits StatefulComponent
@inject GetCategoryHandler GetCategoryDescriptionHandler
@inject CreateBudgetHandler CreateBudgetHandler
@inject UpdateBudgetHandler UpdateBudgetHandler
@inject DeleteBudgetHandler DeleteBudgetHandler
@inject ILogger<BudgetGrid> Logger

<RadzenDataGrid @ref="@grid"
				Responsive="true"
				AllowColumnResize="true"
				AllowAlternatingRows="true"
				EditMode="DataGridEditMode.Single"
				Density="Density.Compact"
				RowCreate="@OnCreateAsync"
				RowUpdate="@OnUpdateAsync"
				TItem="Models.Budget"
				Data="@Data"
				Style="@($"overflow:scroll{(Type is not BudgetType.Summary ? "; max-height: 24vh" : "; width: 75vw")}")">
	<Columns>
		@if (Type != BudgetType.Summary)
		{
			<RadzenDataGridColumn Width="100px"
								  Filterable="false"
								  Sortable="false"
								  TextAlign="TextAlign.Left">
				<HeaderTemplate>
					<RadzenText TextStyle="TextStyle.Body1">
						<strong>
							@FirstColumnHeader
						</strong>
					</RadzenText>
				</HeaderTemplate>
				<Template Context="data">
					<RadzenText TextStyle="TextStyle.Body1">
						<strong>
							@data.CategoryDesc
						</strong>
					</RadzenText>
				</Template>
				<EditTemplate Context="data">
					@switch (operation)
					{
						case GridOperation.Create:
							<RadzenAutoComplete Name="Category"
												Data="@categories"
												TextProperty="Description"
												@bind-Value="@selectedCategoryDesc"
												FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
												FilterOperator="StringFilterOperator.Contains"
												Style="width: 100%" />
							break;
						case GridOperation.Update:
							<RadzenTextBox Name="Category"
										   @bind-Value="@selectedCategoryDesc"
										   Style="width:100%" />
							break;
					}

					<RadzenRequiredValidator Component="Category" Text="@($"{FirstColumnHeader} category is required")" Popup="false" Style="display: block" />
					<RadzenRegexValidator Component="Category" Text="@($"{FirstColumnHeader} category shouldn't conatin any special characters")" Pattern="[a-zA-Z\d ]*" Popup="false" Style="display: block" />
				</EditTemplate>
			</RadzenDataGridColumn>
		}
		<RadzenDataGridColumn Width="50px"
							  Property="Jan"
							  Title="Jan"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@Render(data.Jan, data.IsTotalCategory)
			</Template>
			<EditTemplate Context="data">
				<RadzenNumeric Name="Jan" @bind-Value="@data.Jan" Min="0" ShowUpDown="false" Style="width:100%" />
				<RadzenNumericRangeValidator Component="Jan" Min="0.00m" Text="Amount can't be less than zero" Popup="true" Style="position: absolute" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Property="Feb"
							  Title="Feb"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@Render(data.Feb, data.IsTotalCategory)
			</Template>
			<EditTemplate Context="data">
				<RadzenNumeric Name="Feb" @bind-Value="@data.Feb" Min="0" ShowUpDown="false" Style="width:100%" />
				<RadzenNumericRangeValidator Component="Feb" Min="0.00m" Text="Amount can't be less than zero" Popup="true" Style="position: absolute" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Property="Mar"
							  Title="Mar"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@Render(data.Mar, data.IsTotalCategory)
			</Template>
			<EditTemplate Context="data">
				<RadzenNumeric Name="Mar" @bind-Value="@data.Mar" Min="0" ShowUpDown="false" Style="width:100%" />
				<RadzenNumericRangeValidator Component="Mar" Min="0.00m" Text="Amount can't be less than zero" Popup="true" Style="position: absolute" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Property="Apr"
							  Title="Apr"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@Render(data.Apr, data.IsTotalCategory)
			</Template>
			<EditTemplate Context="data">
				<RadzenNumeric Name="Apr" @bind-Value="@data.Apr" Min="0" ShowUpDown="false" Style="width:100%" />
				<RadzenNumericRangeValidator Component="Apr" Min="0.00m" Text="Amount can't be less than zero" Popup="true" Style="position: absolute" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Property="May"
							  Title="May"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@Render(data.May, data.IsTotalCategory)
			</Template>
			<EditTemplate Context="data">
				<RadzenNumeric Name="May" @bind-Value="@data.May" Min="0" ShowUpDown="false" Style="width:100%" />
				<RadzenNumericRangeValidator Component="May" Min="0.00m" Text="Amount can't be less than zero" Popup="true" Style="position: absolute" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Property="Jun"
							  Title="Jun"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@Render(data.Jun, data.IsTotalCategory)
			</Template>
			<EditTemplate Context="data">
				<RadzenNumeric Name="Jun" @bind-Value="@data.Jun" Min="0" ShowUpDown="false" Style="width:100%" />
				<RadzenNumericRangeValidator Component="Jun" Min="0.00m" Text="Amount can't be less than zero" Popup="true" Style="position: absolute" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Property="Jul"
							  Title="Jul"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@Render(data.Jul, data.IsTotalCategory)
			</Template>
			<EditTemplate Context="data">
				<RadzenNumeric Name="Jul" @bind-Value="@data.Jul" Min="0" ShowUpDown="false" Style="width:100%" />
				<RadzenNumericRangeValidator Component="Jul" Min="0.00m" Text="Amount can't be less than zero" Popup="true" Style="position: absolute" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Property="Aug"
							  Title="Aug"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@Render(data.Aug, data.IsTotalCategory)
			</Template>
			<EditTemplate Context="data">
				<RadzenNumeric Name="Aug" @bind-Value="@data.Aug" Min="0" ShowUpDown="false" Style="width:100%" />
				<RadzenNumericRangeValidator Component="Aug" Min="0.00m" Text="Amount can't be less than zero" Popup="true" Style="position: absolute" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Property="Sep"
							  Title="Sep"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@Render(data.Sep, data.IsTotalCategory)
			</Template>
			<EditTemplate Context="data">
				<RadzenNumeric Name="Sep" @bind-Value="@data.Sep" Min="0" ShowUpDown="false" Style="width:100%" />
				<RadzenNumericRangeValidator Component="Sep" Min="0.00m" Text="Amount can't be less than zero" Popup="true" Style="position: absolute" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Property="Oct"
							  Title="Oct"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@Render(data.Oct, data.IsTotalCategory)
			</Template>
			<EditTemplate Context="data">
				<RadzenNumeric Name="Oct" @bind-Value="@data.Oct" Min="0" ShowUpDown="false" Style="width:100%" />
				<RadzenNumericRangeValidator Component="Oct" Min="0.00m" Text="Amount can't be less than zero" Popup="true" Style="position: absolute" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Property="Nov"
							  Title="Nov"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@Render(data.Nov, data.IsTotalCategory)
			</Template>
			<EditTemplate Context="data">
				<RadzenNumeric Name="Nov" @bind-Value="@data.Nov" Min="0" ShowUpDown="false" Style="width:100%" />
				<RadzenNumericRangeValidator Component="Nov" Min="0.00m" Text="Amount can't be less than zero" Popup="true" Style="position: absolute" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Property="Dec"
							  Title="Dec"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@Render(data.Dec, data.IsTotalCategory)
			</Template>
			<EditTemplate Context="data">
				<RadzenNumeric Name="Dec" @bind-Value="@data.Dec" Min="0" ShowUpDown="false" Style="width:100%" />
				<RadzenNumericRangeValidator Component="Dec" Min="0.00m" Text="Amount can't be less than zero" Popup="true" Style="position: absolute" />
			</EditTemplate>
		</RadzenDataGridColumn>
		<RadzenDataGridColumn Width="50px"
							  Property="Total"
							  Title="Total"
							  Filterable="false"
							  Sortable="false"
							  TextAlign="TextAlign.Right">
			<Template Context="data">
				@Render(data.Total, true)
			</Template>
		</RadzenDataGridColumn>
		@if (Type != BudgetType.Summary)
		{
			<RadzenDataGridColumn Width="75px"
								  Filterable="false"
								  Sortable="false"
								  TextAlign="TextAlign.Right">
				<HeaderTemplate>
					<RadzenButton Icon="add_circle" Text="Add" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" Click="@OnAddRowAsync" />
				</HeaderTemplate>
				<Template Context="data">
					<RadzenIcon Icon="edit" @onclick="async (args) => await OnEditRowAsync(data)" Style="cursor:pointer" Visible="@(!data.IsTotalCategory)" />
					<RadzenIcon Icon="delete" IconStyle="IconStyle.Danger" @onclick="async () => await OnDeleteAsync(data)" Style="cursor:pointer" Visible="@(!data.IsTotalCategory)" />
				</Template>
				<EditTemplate Context="data">
					<RadzenIcon Icon="check_circle" IconStyle="IconStyle.Success" @onclick="async (args) => await OnSaveRowAsync(data)" Style="cursor:pointer" Visible="@(!data.IsTotalCategory)" />
					<RadzenIcon Icon="cancel" IconStyle="IconStyle.Danger" @onclick="async (args) => await OnCancelEditAsync(data)" Style="cursor:pointer" Visible="@(!data.IsTotalCategory)" />
				</EditTemplate>
			</RadzenDataGridColumn>
		}
	</Columns>
</RadzenDataGrid>

@code
{
	RenderFragment Render(decimal amount, bool isTotalCategory) => __builder =>
	{
		@if (amount != 0)
		{
			@Render(amount.ToCurrency(), isTotalCategory)
		}
		else
		{
			@Render(Type is BudgetType.Summary ? "✅" : " - ", isTotalCategory)
		}
	};
	RenderFragment Render(string text, bool isTotal) => __builder =>
	{
		@if (isTotal)
		{
			<strong>
				@text
			</strong>
		}
		else
		{
			@text
		}
	};
}
